name: Build and Release

on:
  push:
    tags: ['v*']
  pull_request:
    branches: [main, master]
  workflow_dispatch:  # 允许手动触发

env:
  FLUTTER_VERSION: '3.31.0'  # 使用支持 Dart 3.8.0+ 的 Flutter 版本

jobs:
  build-web:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: web
            build-command: build web --release
            artifact-name: karing-web
            artifact-path: build/web/

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build ${{ matrix.platform }}
      run: flutter ${{ matrix.build-command }}

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}
        retention-days: 30

  build-android:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: android
            build-command: build apk --release
            artifact-name: karing-android
            artifact-path: build/app/outputs/flutter-apk/app-release.apk
          - platform: android-appbundle
            build-command: build appbundle --release
            artifact-name: karing-appbundle
            artifact-path: build/app/outputs/bundle/release/app-release.aab

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build ${{ matrix.platform }}
      run: flutter ${{ matrix.build-command }}

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}
        retention-days: 30

  build-windows:
    runs-on: windows-latest
    strategy:
      matrix:
        include:
          - platform: windows
            build-command: build windows --release
            artifact-name: karing-windows
            artifact-path: build/windows/runner/Release/

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build ${{ matrix.platform }}
      run: flutter ${{ matrix.build-command }}

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}
        retention-days: 30

  build-linux:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - platform: linux
            build-command: build linux --release
            artifact-name: karing-linux
            artifact-path: build/linux/

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Install Linux dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgtk-3-dev ninja-build

    - name: Build ${{ matrix.platform }}
      run: flutter ${{ matrix.build-command }}

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}
        retention-days: 30

  build-macos:
    runs-on: macos-latest
    strategy:
      matrix:
        include:
          - platform: macos
            build-command: build macos --release
            artifact-name: karing-macos
            artifact-path: build/macos/Build/Products/Release/

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Build ${{ matrix.platform }}
      run: flutter ${{ matrix.build-command }}

    - name: Upload ${{ matrix.platform }} artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact-name }}
        path: ${{ matrix.artifact-path }}
        retention-days: 30

  create-release:
    runs-on: ubuntu-latest
    needs: [build-web, build-android, build-windows, build-linux, build-macos]
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4

    - name: List downloaded artifacts
      run: ls -R

    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          karing-web/**/*
          karing-android/app-release.apk
          karing-appbundle/app-release.aab
          karing-windows/**/*
          karing-linux/**/*
          karing-macos/**/*
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  test:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: ${{ env.FLUTTER_VERSION }}
        channel: 'stable'

    - name: Install dependencies
      run: flutter pub get

    - name: Analyze code
      run: flutter analyze

    - name: Run tests
      run: flutter test
